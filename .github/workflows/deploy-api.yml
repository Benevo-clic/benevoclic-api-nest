name: Deploy API to OVH VPS

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'Dockerfile'
      - '.github/workflows/deploy-api.yml'

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy API to Production
        uses: appleboy/ssh-action@v1.0.3
        env:
          MONGODB_URL: ${{ secrets.MONGODB_URL }}
          MONGODB_DB_NAME: benevoclic
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_BUCKET_NAME: ${{ secrets.AWS_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: 22
          envs: MONGODB_URL,MONGODB_DB_NAME,FIREBASE_CLIENT_EMAIL,FIREBASE_PRIVATE_KEY,FIREBASE_PROJECT_ID,FIREBASE_API_KEY,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_BUCKET_NAME,AWS_REGION
          script: |
            set -e
            echo "🚀 Déploiement API BenevoClic"
            
            cd ~/benevoclic
            
            # API docker-compose
            cat > docker-compose.api.yml << 'EOL'
            services:
              api:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/benevoclic-api:latest
                container_name: benevoclic-api
                restart: always
                ports: ["3000:3000"]
                environment:
                  NODE_ENV: production
                  PORT: 3000
                  MONGODB_URL: ${MONGODB_URL}
                  MONGODB_DB_NAME: ${MONGODB_DB_NAME}
                  FIREBASE_CLIENT_EMAIL: ${FIREBASE_CLIENT_EMAIL}
                  FIREBASE_PRIVATE_KEY: ${FIREBASE_PRIVATE_KEY}
                  FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
                  FIREBASE_API_KEY: ${FIREBASE_API_KEY}
                  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
                  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
                  AWS_BUCKET_NAME: ${AWS_BUCKET_NAME}
                  AWS_REGION: ${AWS_REGION}
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
                  interval: 30s
                  timeout: 3s
                  retries: 3
                  start_period: 10s
                networks: [benevoclic-network]
            networks:
              benevoclic-network:
                external: true
            EOL
            
            # Déployer l'API
            echo "🛑 Arrêt de l'API..."
            docker-compose -f docker-compose.api.yml down || true
            
            echo "📥 Téléchargement de l'image API..."
            docker-compose -f docker-compose.api.yml pull
            
            echo "�� Démarrage de l'API..."
            docker-compose -f docker-compose.api.yml up -d
            
            echo "⏳ Attente du démarrage..."
            sleep 15
            
            echo "✅ Déploiement API terminé !"
            echo "🔍 API Health: http://151.80.152.63:3000/health"