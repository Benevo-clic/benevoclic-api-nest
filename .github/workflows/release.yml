name: Release Management

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type de release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      release_notes:
        description: 'Notes de release (optionnel)'
        required: false
        type: string
  push:
    tags:
      - 'v*'

jobs:
  # Job pour cr√©er une nouvelle release
  create-release:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Bump version
        id: bump
        run: |
          # Installer semantic-release
          npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/npm
          
          # Configuration pour le bump de version
          if [ "${{ github.event.inputs.release_type }}" = "major" ]; then
            echo "RELEASE_TYPE=major" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.release_type }}" = "minor" ]; then
            echo "RELEASE_TYPE=minor" >> $GITHUB_ENV
          else
            echo "RELEASE_TYPE=patch" >> $GITHUB_ENV
          fi
          
          # Lire la version actuelle
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          
          # Calculer la nouvelle version
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          if [ "$RELEASE_TYPE" = "major" ]; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_VERSION="$NEW_MAJOR.0.0"
          elif [ "$RELEASE_TYPE" = "minor" ]; then
            NEW_MINOR=$((MINOR + 1))
            NEW_VERSION="$MAJOR.$NEW_MINOR.0"
          else
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          fi
          
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          npm version ${{ steps.bump.outputs.new_version }} --no-git-tag-version
          echo "Version mise √† jour vers ${{ steps.bump.outputs.new_version }}"

      - name: Update CHANGELOG.md
        run: |
          # Cr√©er une entr√©e temporaire pour la nouvelle version
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          # Cr√©er un fichier temporaire avec la nouvelle entr√©e
          cat > temp_changelog.md << EOF
          ## [$NEW_VERSION] - $CURRENT_DATE
          
          ### üöÄ Ajout√©
          - Release $NEW_VERSION
          
          ### üîß Modifi√©
          - Mise √† jour de la version
          
          ---
          
          EOF
          
          # Ajouter au d√©but du CHANGELOG.md (apr√®s la section Unreleased)
          sed -i "/^## \[Unreleased\]/a\\" temp_changelog.md
          sed -i "/^## \[Unreleased\]/r temp_changelog.md" CHANGELOG.md
          rm temp_changelog.md

      - name: Create Git tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }}"
          git tag -a "v${{ steps.bump.outputs.new_version }}" -m "Release v${{ steps.bump.outputs.new_version }}"
          git push origin main --tags

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.bump.outputs.new_version }}
          release_name: Release v${{ steps.bump.outputs.new_version }}
          body: |
            ## üöÄ Release v${{ steps.bump.outputs.new_version }}
            
            ### üìã R√©sum√© des changements
            
            Consultez le [CHANGELOG.md](CHANGELOG.md) pour plus de d√©tails.
            
            ### üîÑ D√©ploiement
            
            Cette release sera automatiquement d√©ploy√©e via les workflows GitHub Actions.
            
            ### üìä Monitoring
            
            - [Prometheus](http://IP_VPS:9090)
            - [Grafana](http://IP_VPS:3001)
            - [Alertmanager](http://IP_VPS:9093)
            
            ---
            
            *Release g√©n√©r√©e automatiquement*
          draft: false
          prerelease: false

  # Job pour d√©ployer automatiquement lors d'un tag
  deploy-release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: []
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "D√©ploiement de la version $VERSION"

      - name: Deploy to Production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "üöÄ D√©ploiement de la version ${{ steps.version.outputs.version }}"
            
            cd ~/benevoclic
            
            # Mettre √† jour le code
            git pull origin main
            
            # Installer les d√©pendances
            npm install
            
            # Build de l'application
            npm run build
            
            # Red√©marrer les services
            pm2 restart benevoclic-api
            
            # V√©rifier le d√©ploiement
            sleep 10
            curl -f http://IP_VPS:3000/health || exit 1
            
            echo "‚úÖ D√©ploiement de la version ${{ steps.version.outputs.version }} termin√© !"

      - name: Notify Discord
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\":\"‚úÖ **Release v${{ steps.version.outputs.version }} d√©ploy√©e avec succ√®s !**\\n\\nüì¶ Version: v${{ steps.version.outputs.version }}\\nüîó [Voir les changements](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})\\nüìä [Monitoring](http://IP_VPS:9090)\"}" \
              ${{ secrets.WEBHOOK_URL }}
          else
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\":\"‚ùå **√âchec du d√©ploiement de la release v${{ steps.version.outputs.version }}**\\n\\nüîç V√©rifiez les logs du workflow pour plus de d√©tails.\"}" \
              ${{ secrets.WEBHOOK_URL }}
          fi

  # Job pour g√©n√©rer les release notes
  generate-release-notes:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: []
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Extraire la version
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # G√©n√©rer les release notes depuis le CHANGELOG.md
          RELEASE_NOTES=$(awk "/^## \\[$VERSION\\]/ {p=1; next} /^## \\[/ {p=0} p" CHANGELOG.md | sed '/^$/d')
          
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update Release
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const release = releases.find(r => r.tag_name === context.ref.replace('refs/tags/', ''));
            
            if (release) {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                body: `${{ steps.release_notes.outputs.release_notes }}`
              });
            } 