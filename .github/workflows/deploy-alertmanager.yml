name: Deploy Alertmanager to OVH VPS

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'alertmanager.yml'
      - 'alertmanager-templates.yml'
      - '.github/workflows/deploy-alertmanager.yml'

jobs:
  deploy-alertmanager:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Alertmanager to Production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "ðŸš¨ DÃ©ploiement Alertmanager"
            
            cd ~/benevoclic
            
            # Alertmanager config
            cat > alertmanager.yml << 'EOL'
            global:
              resolve_timeout: 5m
            route:
              group_by: ['alertname']
              group_wait: 10s
              group_interval: 10s
              repeat_interval: 1h
              receiver: 'discord-server-down'
              routes:
                - match:
                    alert_type: server_down
                  receiver: 'discord-server-down'
                  repeat_interval: 30m
                - match:
                    alert_type: server_up
                  receiver: 'discord-server-up'
                  repeat_interval: 1h
                - match:
                    alert_type: server_inactive
                  receiver: 'discord-server-inactive'
                  repeat_interval: 15m
                - match:
                    severity: critical
                  receiver: 'discord-critical'
                  repeat_interval: 30m
                - match:
                    severity: warning
                  receiver: 'discord-warning'
                  repeat_interval: 1h
                - match:
                    severity: info
                  receiver: 'discord-info'
                  repeat_interval: 2h
            receivers:
              - name: 'discord-server-down'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: 'ðŸš¨ SERVEUR TOMBÃ‰ - BenevoClic'
                    message: |
                      ðŸ”´ **SERVEUR TOMBÃ‰ - BenevoClic**

                      **ðŸš¨ URGENCE: Le serveur est inaccessible !**

                      **RÃ©sumÃ©:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **SÃ©vÃ©ritÃ©:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **DÃ©tails de l'incident:**
                      {{ range .Alerts }}
                      â€¢ **Instance:** {{ .Labels.instance }}
                      â€¢ **Status:** {{ .Status }}
                      â€¢ **DurÃ©e:** {{ .StartsAt | since }}
                      {{ end }}

                      **Actions requises:**
                      â€¢ ðŸ” VÃ©rifier l'Ã©tat du serveur
                      â€¢ ðŸ”„ RedÃ©marrer les services si nÃ©cessaire
                      â€¢ ðŸ“ž Contacter l'Ã©quipe technique

                      **Liens utiles:**
                      â€¢ ðŸ“Š [Prometheus](http://151.80.152.63:9090)
                      â€¢ ðŸ“ˆ [Grafana](http://151.80.152.63:3001)
                      â€¢ ðŸ” [API Health](http://151.80.152.63:3000/health)

                      ---
                      *ðŸ”´ ALERTE CRITIQUE - Serveur Down*
                    send_resolved: true

              - name: 'discord-server-up'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: 'âœ… SERVEUR RÃ‰TABLI - BenevoClic'
                    message: |
                      ðŸŸ¢ **SERVEUR RÃ‰TABLI - BenevoClic**

                      **ðŸŽ‰ BONNE NOUVELLE: Le serveur est de nouveau opÃ©rationnel !**

                      **RÃ©sumÃ©:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **SÃ©vÃ©ritÃ©:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **DÃ©tails de la rÃ©cupÃ©ration:**
                      {{ range .Alerts }}
                      â€¢ **Instance:** {{ .Labels.instance }}
                      â€¢ **Status:** {{ .Status }}
                      â€¢ **DurÃ©e de l'incident:** {{ .StartsAt | since }} - {{ .EndsAt | since }}
                      {{ end }}

                      **Services rÃ©tablis:**
                      â€¢ ðŸŸ¢ API BenevoClic
                      â€¢ ðŸŸ¢ Monitoring Prometheus
                      â€¢ ðŸŸ¢ Alertes Discord
                      â€¢ ðŸŸ¢ Dashboards Grafana

                      **Liens utiles:**
                      â€¢ ðŸ“Š [Prometheus](http://151.80.152.63:9090)
                      â€¢ ðŸ“ˆ [Grafana](http://151.80.152.63:3001)
                      â€¢ ðŸ” [API Health](http://151.80.152.63:3000/health)

                      ---
                      *ðŸŸ¢ RÃ‰CUPÃ‰RATION - Serveur OpÃ©rationnel*
                    send_resolved: true

              - name: 'discord-server-inactive'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: 'âš ï¸ SERVEUR INACTIF - BenevoClic'
                    message: |
                      âš ï¸ **SERVEUR INACTIF - BenevoClic**

                      **ðŸ“‰ ATTENTION: Le serveur est inactif depuis trop longtemps !**

                      **RÃ©sumÃ©:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **SÃ©vÃ©ritÃ©:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **DÃ©tails de l'inactivitÃ©:**
                      {{ range .Alerts }}
                      â€¢ **Instance:** {{ .Labels.instance }}
                      â€¢ **Status:** {{ .Status }}
                      â€¢ **DurÃ©e d'inactivitÃ©:** {{ .StartsAt | since }}
                      â€¢ **DerniÃ¨re activitÃ©:** {{ .Annotations.last_activity | default "Inconnue" }}
                      {{ end }}

                      **Causes possibles:**
                      â€¢ ðŸ”Œ ProblÃ¨me de connectivitÃ© rÃ©seau
                      â€¢ ðŸ’¾ Surcharge du serveur
                      â€¢ ðŸ”„ Service en cours de redÃ©marrage
                      â€¢ âš¡ ProblÃ¨me d'alimentation

                      **Actions recommandÃ©es:**
                      â€¢ ðŸ” VÃ©rifier la connectivitÃ©
                      â€¢ ðŸ“Š Consulter les mÃ©triques systÃ¨me
                      â€¢ ðŸ”„ RedÃ©marrer si nÃ©cessaire

                      **Liens utiles:**
                      â€¢ ðŸ“Š [Prometheus](http://151.80.152.63:9090)
                      â€¢ ðŸ“ˆ [Grafana](http://151.80.152.63:3001)
                      â€¢ ðŸ” [API Health](http://151.80.152.63:3000/health)

                      ---
                      *âš ï¸ ALERTE INACTIVITÃ‰ - Surveillance Requise*
                    send_resolved: true

              - name: 'discord-critical'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: 'ðŸš¨ ALERTE CRITIQUE - BenevoClic'
                    message: |
                      ðŸš¨ **Alerte BenevoClic**

                      **RÃ©sumÃ©:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **SÃ©vÃ©ritÃ©:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **DÃ©tails:**
                      {{ range .Alerts }}
                      â€¢ **Instance:** {{ .Labels.instance }}
                      â€¢ **Valeur:** {{ .Annotations.value }}
                      â€¢ **Status:** {{ .Status }}
                      {{ end }}

                      **Liens utiles:**
                      â€¢ ðŸ“Š [Prometheus](http://151.80.152.63:9090)
                      â€¢ ðŸ“ˆ [Grafana](http://151.80.152.63:3001)
                      â€¢ ðŸ” [API Health](http://151.80.152.63:3000/health)

                      ---
                      *Alertmanager - BenevoClic Monitoring*
                    send_resolved: true

              - name: 'discord-warning'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: 'âš ï¸ ALERTE WARNING - BenevoClic'
                    message: |
                      ðŸš¨ **Alerte BenevoClic**

                      **RÃ©sumÃ©:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **SÃ©vÃ©ritÃ©:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **DÃ©tails:**
                      {{ range .Alerts }}
                      â€¢ **Instance:** {{ .Labels.instance }}
                      â€¢ **Valeur:** {{ .Annotations.value }}
                      â€¢ **Status:** {{ .Status }}
                      {{ end }}

                      **Liens utiles:**
                      â€¢ ðŸ“Š [Prometheus](http://151.80.152.63:9090)
                      â€¢ ðŸ“ˆ [Grafana](http://151.80.152.63:3001)
                      â€¢ ðŸ” [API Health](http://151.80.152.63:3000/health)

                      ---
                      *Alertmanager - BenevoClic Monitoring*
                    send_resolved: true

              - name: 'discord-info'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: 'â„¹ï¸ INFO - BenevoClic'
                    message: |
                      ðŸš¨ **Alerte BenevoClic**

                      **RÃ©sumÃ©:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **SÃ©vÃ©ritÃ©:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **DÃ©tails:**
                      {{ range .Alerts }}
                      â€¢ **Instance:** {{ .Labels.instance }}
                      â€¢ **Valeur:** {{ .Annotations.value }}
                      â€¢ **Status:** {{ .Status }}
                      {{ end }}

                      **Liens utiles:**
                      â€¢ ðŸ“Š [Prometheus](http://151.80.152.63:9090)
                      â€¢ ðŸ“ˆ [Grafana](http://151.80.152.63:3001)
                      â€¢ ðŸ” [API Health](http://151.80.152.63:3000/health)

                      ---
                      *Alertmanager - BenevoClic Monitoring*
                    send_resolved: true

            inhibit_rules:
              - source_match:
                  severity: 'critical'
                target_match:
                  severity: 'warning'
                equal: ['alertname']
              - source_match:
                  alert_type: 'server_down'
                target_match:
                  alert_type: 'server_inactive'
                equal: ['service']
            EOL
            

            
            # Alertmanager docker-compose
            cat > docker-compose.alertmanager.yml << 'EOL'
            services:
              alertmanager:
                image: prom/alertmanager:latest
                container_name: alertmanager
                restart: always
                ports: ["9093:9093"]
                volumes:
                  - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
                  - alertmanager_data:/alertmanager
                command:
                  - '--config.file=/etc/alertmanager/alertmanager.yml'
                  - '--storage.path=/alertmanager'
                  - '--web.listen-address=:9093'
                networks: [benevoclic-network]

            volumes:
              alertmanager_data:

            networks:
              benevoclic-network:
                external: true
            EOL
            
            # DÃ©ployer Alertmanager
            echo "ðŸ›‘ ArrÃªt d'Alertmanager..."
            docker-compose -f docker-compose.alertmanager.yml down || true
            
            echo "ðŸš¨ DÃ©marrage d'Alertmanager..."
            docker-compose -f docker-compose.alertmanager.yml up -d
            
            echo "â³ Attente du dÃ©marrage..."
            sleep 10
            
            echo "âœ… DÃ©ploiement Alertmanager terminÃ© !"
            echo "ï¿½ï¿½ Alertmanager: http://151.80.152.63:9093"