name: Deploy to OVH VPS

on:
  workflow_dispatch:

jobs:
  deploy-to-ovh:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@v1.0.3
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          API_SIRENE_URL: ${{ secrets.API_SIRENE_URL }}
          API_KEY: ${{ secrets.API_KEY }}
          API_SIRENE_KEY: ${{ secrets.API_SIRENE_KEY }}
          STORAGE_BUCKET: ${{ secrets.STORAGE_BUCKET }}
          MESSAGING_SENDER_ID: ${{ secrets.MESSAGING_SENDER_ID }}
          APP_ID: ${{ secrets.APP_ID }}
          MEASUREMENT_ID: ${{ secrets.MEASUREMENT_ID }}
          PORT: ${{ secrets.PORT }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          API_TIMEOUT: ${{ secrets.API_TIMEOUT }}
          API_RETRY_COUNT: ${{ secrets.API_RETRY_COUNT }}
          GOOGLE_CALLBACK_URL: ${{ secrets.GOOGLE_CALLBACK_URL }}
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: 22
          envs: API_BASE_URL,API_SIRENE_URL,API_KEY,API_SIRENE_KEY,STORAGE_BUCKET,MESSAGING_SENDER_ID,APP_ID,MEASUREMENT_ID,PORT,NODE_ENV,API_TIMEOUT,API_RETRY_COUNT,GOOGLE_CALLBACK_URL,FIREBASE_API_KEY,FIREBASE_AUTH_DOMAIN,FIREBASE_PROJECT_ID,FIREBASE_STORAGE_BUCKET,FIREBASE_MESSAGING_SENDER_ID,FIREBASE_APP_ID,FIREBASE_MEASUREMENT_ID
          script: |
            set -e
            echo "ï¿½ï¿½ DÃ©ploiement BenevoClic avec Discord"
            
            # CrÃ©er rÃ©pertoires
            mkdir -p ~/benevoclic/grafana/dashboards ~/benevoclic/grafana/datasources
            
            # API docker-compose
            cat > ~/benevoclic/docker-compose.yml << 'EOL'
            services:
              api:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/benevoclic-api:latest
                container_name: benevoclic-api
                restart: always
                ports: ["3000:3000"]
                environment:
                  NODE_ENV: production
                  PORT: 3000
                  API_BASE_URL: ${API_BASE_URL}
                  API_SIRENE_URL: ${API_SIRENE_URL}
                  API_KEY: ${API_KEY}
                  API_SIRENE_KEY: ${API_SIRENE_KEY}
                  STORAGE_BUCKET: ${STORAGE_BUCKET}
                  MESSAGING_SENDER_ID: ${MESSAGING_SENDER_ID}
                  APP_ID: ${APP_ID}
                  MEASUREMENT_ID: ${MEASUREMENT_ID}
                  API_TIMEOUT: ${API_TIMEOUT}
                  API_RETRY_COUNT: ${API_RETRY_COUNT}
                  GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
                  FIREBASE_API_KEY: ${FIREBASE_API_KEY}
                  FIREBASE_AUTH_DOMAIN: ${FIREBASE_AUTH_DOMAIN}
                  FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
                  FIREBASE_STORAGE_BUCKET: ${FIREBASE_STORAGE_BUCKET}
                  FIREBASE_MESSAGING_SENDER_ID: ${FIREBASE_MESSAGING_SENDER_ID}
                  FIREBASE_APP_ID: ${FIREBASE_APP_ID}
                  FIREBASE_MEASUREMENT_ID: ${FIREBASE_MEASUREMENT_ID}
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
                  interval: 30s
                  timeout: 3s
                  retries: 3
                  start_period: 10s
                networks: [benevoclic-network]
            networks:
              benevoclic-network:
                external: true
            EOL
            
            # Prometheus config
            cat > ~/benevoclic/prometheus.yml << 'EOL'
            global:
              scrape_interval: 15s
              evaluation_interval: 15s
            rule_files: ["alert_rules.yml"]
            scrape_configs:
              - job_name: 'prometheus'
                static_configs: [{'targets': ['localhost:9090']}]
              - job_name: 'benevoclic-api'
                static_configs: [{'targets': ['benevoclic-api:3000']}]
                metrics_path: '/metrics'
                scrape_interval: 10s
                scrape_timeout: 5s
                relabel_configs:
                  - source_labels: [__address__]
                    target_label: instance
                    regex: '(.+)'
                    replacement: '${1}'
                  - source_labels: [__address__]
                    target_label: service
                    regex: '(.+)'
                    replacement: 'benevoclic-api'
              - job_name: 'node-exporter'
                static_configs: [{'targets': ['node-exporter:9100']}]
                scrape_interval: 15s
            alerting:
              alertmanagers:
                - static_configs:
                    - targets: [alertmanager:9093]
            EOL
            
            # Alertmanager Discord
            cat > ~/benevoclic/alertmanager.yml << 'EOL'
            global:
              resolve_timeout: 5m
            route:
              group_by: ['alertname']
              group_wait: 10s
              group_interval: 10s
              repeat_interval: 1h
              receiver: 'discord-only'
              routes:
                - match: {severity: critical}
                  receiver: 'discord-only'
                  repeat_interval: 30m
                - match: {severity: warning}
                  receiver: 'discord-only'
                  repeat_interval: 1h
            receivers:
              - name: 'discord-only'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: 'ğŸš¨ Alerte BenevoClic'
                    message: '{{ template "discord.benevoclic.message" . }}'
                    send_resolved: true
            inhibit_rules:
              - source_match: {severity: 'critical'}
                target_match: {severity: 'warning'}
                equal: ['alertname']
            EOL
            
            # Monitoring docker-compose
            cat > ~/benevoclic/docker-compose.monitoring.yml << 'EOL'
            services:
              prometheus:
                image: prom/prometheus:latest
                container_name: prometheus
                restart: always
                ports: ["9090:9090"]
                volumes:
                  - ./prometheus.yml:/etc/prometheus/prometheus.yml
                  - prometheus_data:/prometheus
                command:
                  - '--config.file=/etc/prometheus/prometheus.yml'
                  - '--storage.tsdb.path=/prometheus'
                  - '--web.console.libraries=/etc/prometheus/console_libraries'
                  - '--web.console.templates=/etc/prometheus/consoles'
                  - '--storage.tsdb.retention.time=200h'
                  - '--web.enable-lifecycle'
                networks: [benevoclic-network]
              grafana:
                image: grafana/grafana:latest
                container_name: grafana
                restart: always
                ports: ["3001:3000"]
                environment:
                  - GF_SECURITY_ADMIN_USER=admin
                  - GF_SECURITY_ADMIN_PASSWORD=admin123
                  - GF_USERS_ALLOW_SIGN_UP=false
                volumes:
                  - grafana_data:/var/lib/grafana
                  - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
                  - ./grafana/datasources:/etc/grafana/provisioning/datasources
                networks: [benevoclic-network]
              node-exporter:
                image: prom/node-exporter:latest
                container_name: node-exporter
                restart: always
                ports: ["9100:9100"]
                volumes:
                  - /proc:/host/proc:ro
                  - /sys:/host/sys:ro
                  - /:/rootfs:ro
                command:
                  - '--path.procfs=/host/proc'
                  - '--path.rootfs=/rootfs'
                  - '--path.sysfs=/host/sys'
                  - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
                networks: [benevoclic-network]
              alertmanager:
                image: prom/alertmanager:latest
                container_name: alertmanager
                restart: always
                ports: ["9093:9093"]
                volumes:
                  - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
                  - alertmanager_data:/alertmanager
                command:
                  - '--config.file=/etc/alertmanager/alertmanager.yml'
                  - '--storage.path=/alertmanager'
                  - '--web.listen-address=:9093'
                networks: [benevoclic-network]
            volumes:
              prometheus_data:
              grafana_data:
              alertmanager_data:
            networks:
              benevoclic-network:
                external: true
            EOL
            
            # Grafana configs
            cat > ~/benevoclic/grafana/datasources/prometheus.yml << 'EOL'
            apiVersion: 1
            datasources:
              - name: Prometheus
                type: prometheus
                access: proxy
                url: http://prometheus:9090
                isDefault: true
                editable: true
            EOL
            
            cat > ~/benevoclic/grafana/dashboards/dashboards.yml << 'EOL'
            apiVersion: 1
            providers:
              - name: 'default'
                orgId: 1
                folder: ''
                type: file
                disableDeletion: false
                updateIntervalSeconds: 10
                allowUiUpdates: true
                options:
                  path: /etc/grafana/provisioning/dashboards
            EOL
            
            cd ~/benevoclic
            
            # DÃ©ployer
            echo "ï¿½ï¿½ ArrÃªt des services..."
            docker-compose down || true
            docker-compose -f docker-compose.monitoring.yml down || true
            
            echo "ï¿½ï¿½ CrÃ©ation du rÃ©seau..."
            docker network create benevoclic-network 2>/dev/null || true
            
            echo "ï¿½ï¿½ TÃ©lÃ©chargement des images..."
            docker-compose pull
            
            echo "ï¿½ï¿½ DÃ©marrage de l'API..."
            docker-compose up -d
            
            echo "ğŸ“Š DÃ©marrage du monitoring..."
            docker-compose -f docker-compose.monitoring.yml up -d
            
            echo "â³ Attente du dÃ©marrage..."
            sleep 15
            
            echo "âœ… DÃ©ploiement terminÃ© !"
            echo "ğŸ“Š Prometheus: http://151.80.152.63:9090"
            echo "ï¿½ï¿½ Alertmanager: http://151.80.152.63:9093"
            echo "ğŸ“ˆ Grafana: http://151.80.152.63:3001 (admin/admin123)"
            echo "ğŸ” API Health: http://151.80.152.63:3000/health"