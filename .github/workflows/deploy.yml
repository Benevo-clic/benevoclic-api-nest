name: Deploy to OVH VPS

on:
  workflow_dispatch:

jobs:
  deploy-to-ovh:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@v1.0.3
        env:
          MONGODB_URL: ${{ secrets.MONGODB_URL }}
          MONGODB_DB_NAME: benevoclic
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_BUCKET_NAME: ${{ secrets.AWS_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: 22
          envs: MONGODB_URL,MONGODB_DB_NAME,FIREBASE_CLIENT_EMAIL,FIREBASE_PRIVATE_KEY,FIREBASE_PROJECT_ID,FIREBASE_API_KEY,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_BUCKET_NAME,AWS_REGION
          script: |
            set -e
            echo "🚀 Déploiement BenevoClic avec monitoring et alertes Discord"
            
            # Créer répertoires
            mkdir -p ~/benevoclic/grafana/dashboards ~/benevoclic/grafana/datasources
            
            # API docker-compose
            cat > ~/benevoclic/docker-compose.yml << 'EOL'
            services:
              api:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/benevoclic-api:latest
                container_name: benevoclic-api
                restart: always
                ports: ["3000:3000"]
                environment:
                  NODE_ENV: production
                  PORT: 3000
                  MONGODB_URL: ${MONGODB_URL}
                  MONGODB_DB_NAME: ${MONGODB_DB_NAME}
                  FIREBASE_CLIENT_EMAIL: ${FIREBASE_CLIENT_EMAIL}
                  FIREBASE_PRIVATE_KEY: ${FIREBASE_PRIVATE_KEY}
                  FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
                  FIREBASE_API_KEY: ${FIREBASE_API_KEY}
                  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
                  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
                  AWS_BUCKET_NAME: ${AWS_BUCKET_NAME}
                  AWS_REGION: ${AWS_REGION}
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
                  interval: 30s
                  timeout: 3s
                  retries: 3
                  start_period: 10s
                networks: [benevoclic-network]
            networks:
              benevoclic-network:
                external: true
            EOL
            
            # Prometheus config
            cat > ~/benevoclic/prometheus.yml << 'EOL'
            global:
              scrape_interval: 15s
              evaluation_interval: 15s
            rule_files: ["alert_rules.yml"]
            scrape_configs:
              - job_name: 'prometheus'
                static_configs: [{'targets': ['localhost:9090']}]
              - job_name: 'benevoclic-api'
                static_configs: [{'targets': ['benevoclic-api:3000']}]
                metrics_path: '/metrics'
                scrape_interval: 10s
                scrape_timeout: 5s
                relabel_configs:
                  - source_labels: [__address__]
                    target_label: instance
                    regex: '(.+)'
                    replacement: '${1}'
                  - source_labels: [__address__]
                    target_label: service
                    regex: '(.+)'
                    replacement: 'benevoclic-api'
              - job_name: 'node-exporter'
                static_configs: [{'targets': ['node-exporter:9100']}]
                scrape_interval: 15s
            alerting:
              alertmanagers:
                - static_configs:
                    - targets: [alertmanager:9093]
            EOL
            
            # Alert rules
            cat > ~/benevoclic/alert_rules.yml << 'EOL'
            groups:
              - name: benevoclic-api
                rules:
                  - alert: ServerDown
                    expr: up{job="benevoclic-api"} == 0
                    for: 1m
                    labels:
                      severity: critical
                      service: benevoclic-api
                      alert_type: server_down
                    annotations:
                      summary: "🚨 SERVEUR TOMBÉ - BenevoClic"
                      description: "Le serveur BenevoClic est complètement inaccessible depuis {{ $labels.instance }}"
                      template: "discord.server.down"

                  - alert: ServerUp
                    expr: up{job="benevoclic-api"} == 1
                    for: 30s
                    labels:
                      severity: info
                      service: benevoclic-api
                      alert_type: server_up
                    annotations:
                      summary: "✅ SERVEUR RÉTABLI - BenevoClic"
                      description: "Le serveur BenevoClic est de nouveau opérationnel sur {{ $labels.instance }}"
                      template: "discord.server.up"

                  - alert: ServerInactive
                    expr: rate(http_requests_total{job="benevoclic-api"}[10m]) == 0
                    for: 10m
                    labels:
                      severity: warning
                      service: benevoclic-api
                      alert_type: server_inactive
                    annotations:
                      summary: "⚠️ SERVEUR INACTIF - BenevoClic"
                      description: "Le serveur BenevoClic est inactif depuis plus de 10 minutes sur {{ $labels.instance }}"
                      template: "discord.server.inactive"
                      last_activity: "{{ $value }}"

                  - alert: APIHighErrorRate
                    expr: rate(http_requests_total{job="benevoclic-api", status=~"5.."}[5m]) > 0.1
                    for: 2m
                    labels:
                      severity: warning
                      service: benevoclic-api
                    annotations:
                      summary: "Taux d'erreur élevé"
                      description: "Le taux d'erreur 5xx est élevé sur {{ $labels.instance }}"

                  - alert: APINoRequests
                    expr: rate(http_requests_total{job="benevoclic-api"}[5m]) == 0
                    for: 5m
                    labels:
                      severity: warning
                      service: benevoclic-api
                    annotations:
                      summary: "Aucune requête API"
                      description: "Aucune requête reçue sur {{ $labels.instance }} depuis 5 minutes"

              - name: system-resources
                rules:
                  - alert: HighCPUUsage
                    expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
                    for: 5m
                    labels:
                      severity: warning
                      service: system
                    annotations:
                      summary: "Utilisation CPU élevée"
                      description: "L'utilisation CPU est élevée sur {{ $labels.instance }}"

                  - alert: HighMemoryUsage
                    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
                    for: 5m
                    labels:
                      severity: warning
                      service: system
                    annotations:
                      summary: "Utilisation mémoire élevée"
                      description: "L'utilisation mémoire est élevée sur {{ $labels.instance }}"

                  - alert: SystemDown
                    expr: up{job="node-exporter"} == 0
                    for: 2m
                    labels:
                      severity: critical
                      service: system
                      alert_type: server_down
                    annotations:
                      summary: "🚨 SYSTÈME TOMBÉ - BenevoClic"
                      description: "Le système de monitoring est inaccessible sur {{ $labels.instance }}"
                      template: "discord.server.down"

                  - alert: SystemUp
                    expr: up{job="node-exporter"} == 1
                    for: 30s
                    labels:
                      severity: info
                      service: system
                      alert_type: server_up
                    annotations:
                      summary: "✅ SYSTÈME RÉTABLI - BenevoClic"
                      description: "Le système de monitoring est de nouveau opérationnel sur {{ $labels.instance }}"
                      template: "discord.server.up"
            EOL
            
            # Alertmanager Discord
            cat > ~/benevoclic/alertmanager.yml << 'EOL'
            global:
              resolve_timeout: 5m
            route:
              group_by: ['alertname']
              group_wait: 10s
              group_interval: 10s
              repeat_interval: 1h
              receiver: 'discord-server-down'
              routes:
                - match:
                    alert_type: server_down
                  receiver: 'discord-server-down'
                  repeat_interval: 30m
                - match:
                    alert_type: server_up
                  receiver: 'discord-server-up'
                  repeat_interval: 1h
                - match:
                    alert_type: server_inactive
                  receiver: 'discord-server-inactive'
                  repeat_interval: 15m
                - match:
                    severity: critical
                  receiver: 'discord-critical'
                  repeat_interval: 30m
                - match:
                    severity: warning
                  receiver: 'discord-warning'
                  repeat_interval: 1h
                - match:
                    severity: info
                  receiver: 'discord-info'
                  repeat_interval: 2h
            receivers:
              - name: 'discord-server-down'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: '🚨 SERVEUR TOMBÉ - BenevoClic'
                    message: |
                      🔴 **SERVEUR TOMBÉ - BenevoClic**

                      **🚨 URGENCE: Le serveur est inaccessible !**

                      **Résumé:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **Sévérité:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **Détails de l'incident:**
                      {{ range .Alerts }}
                      • **Instance:** {{ .Labels.instance }}
                      • **Status:** {{ .Status }}
                      • **Durée:** {{ .StartsAt | since }}
                      {{ end }}

                      **Actions requises:**
                      • 🔍 Vérifier l'état du serveur
                      • 🔄 Redémarrer les services si nécessaire
                      • 📞 Contacter l'équipe technique

                      **Liens utiles:**
                      • 📊 [Prometheus](http://151.80.152.63:9090)
                      • 📈 [Grafana](http://151.80.152.63:3001)
                      • 🚨 [Alertmanager](http://151.80.152.63:9093/#/alerts)
                      • 🔍 [API Health](http://151.80.152.63:3000/health)

                      ---
                      *🔴 ALERTE CRITIQUE - Serveur Down*
                    send_resolved: true

              - name: 'discord-server-up'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: '✅ SERVEUR RÉTABLI - BenevoClic'
                    message: |
                      🟢 **SERVEUR RÉTABLI - BenevoClic**

                      **🎉 BONNE NOUVELLE: Le serveur est de nouveau opérationnel !**

                      **Résumé:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **Sévérité:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **Détails de la récupération:**
                      {{ range .Alerts }}
                      • **Instance:** {{ .Labels.instance }}
                      • **Status:** {{ .Status }}
                      • **Durée de l'incident:** {{ .StartsAt | since }} - {{ .EndsAt | since }}
                      {{ end }}

                      **Services rétablis:**
                      • 🟢 API BenevoClic
                      • 🟢 Monitoring Prometheus
                      • 🟢 Alertes Discord
                      • 🟢 Dashboards Grafana

                      **Liens utiles:**
                      • 📊 [Prometheus](http://151.80.152.63:9090)
                      • 📈 [Grafana](http://151.80.152.63:3001)
                      • 🚨 [Alertmanager](http://151.80.152.63:9093/#/alerts)
                      • 🔍 [API Health](http://151.80.152.63:3000/health)

                      ---
                      *🟢 RÉCUPÉRATION - Serveur Opérationnel*
                    send_resolved: true

              - name: 'discord-server-inactive'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: '⚠️ SERVEUR INACTIF - BenevoClic'
                    message: |
                      ⚠️ **SERVEUR INACTIF - BenevoClic**

                      **📉 ATTENTION: Le serveur est inactif depuis trop longtemps !**

                      **Résumé:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **Sévérité:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **Détails de l'inactivité:**
                      {{ range .Alerts }}
                      • **Instance:** {{ .Labels.instance }}
                      • **Status:** {{ .Status }}
                      • **Durée d'inactivité:** {{ .StartsAt | since }}
                      • **Dernière activité:** {{ .Annotations.last_activity | default "Inconnue" }}
                      {{ end }}

                      **Causes possibles:**
                      • 🔌 Problème de connectivité réseau
                      • 💾 Surcharge du serveur
                      • 🔄 Service en cours de redémarrage
                      • ⚡ Problème d'alimentation

                      **Actions recommandées:**
                      • 🔍 Vérifier la connectivité
                      • 📊 Consulter les métriques système
                      • 🔄 Redémarrer si nécessaire

                      **Liens utiles:**
                      • 📊 [Prometheus](http://151.80.152.63:9090)
                      • 📈 [Grafana](http://151.80.152.63:3001)
                      • 🚨 [Alertmanager](http://151.80.152.63:9093/#/alerts)
                      • 🔍 [API Health](http://151.80.152.63:3000/health)

                      ---
                      *⚠️ ALERTE INACTIVITÉ - Surveillance Requise*
                    send_resolved: true

              - name: 'discord-critical'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: '🚨 ALERTE CRITIQUE - BenevoClic'
                    message: |
                      🚨 **Alerte BenevoClic**

                      **Résumé:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **Sévérité:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **Détails:**
                      {{ range .Alerts }}
                      • **Instance:** {{ .Labels.instance }}
                      • **Valeur:** {{ .Annotations.value }}
                      • **Status:** {{ .Status }}
                      {{ end }}

                      **Liens utiles:**
                      • 📊 [Prometheus](http://151.80.152.63:9090)
                      • 📈 [Grafana](http://151.80.152.63:3001)
                      • 🚨 [Alertmanager](http://151.80.152.63:9093/#/alerts)
                      • 🔍 [API Health](http://151.80.152.63:3000/health)

                      ---
                      *Alertmanager - BenevoClic Monitoring*
                    send_resolved: true

              - name: 'discord-warning'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: '⚠️ ALERTE WARNING - BenevoClic'
                    message: |
                      🚨 **Alerte BenevoClic**

                      **Résumé:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **Sévérité:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **Détails:**
                      {{ range .Alerts }}
                      • **Instance:** {{ .Labels.instance }}
                      • **Valeur:** {{ .Annotations.value }}
                      • **Status:** {{ .Status }}
                      {{ end }}

                      **Liens utiles:**
                      • 📊 [Prometheus](http://151.80.152.63:9090)
                      • 📈 [Grafana](http://151.80.152.63:3001)
                      • 🚨 [Alertmanager](http://151.80.152.63:9093/#/alerts)
                      • 🔍 [API Health](http://151.80.152.63:3000/health)

                      ---
                      *Alertmanager - BenevoClic Monitoring*
                    send_resolved: true

              - name: 'discord-info'
                discord_configs:
                  - webhook_url: 'https://discord.com/api/webhooks/1401898793477214259/tJtF0qpbWZh38taEXVfEu23qdbY53sb_Td3UROUItw-AFzoAeFZAEW5lRp-zTNiYBXLt'
                    title: 'ℹ️ INFO - BenevoClic'
                    message: |
                      🚨 **Alerte BenevoClic**

                      **Résumé:** {{ .CommonAnnotations.summary }}
                      **Description:** {{ .CommonAnnotations.description }}
                      **Sévérité:** {{ .CommonLabels.severity }}
                      **Service:** {{ .CommonLabels.service }}

                      **Détails:**
                      {{ range .Alerts }}
                      • **Instance:** {{ .Labels.instance }}
                      • **Valeur:** {{ .Annotations.value }}
                      • **Status:** {{ .Status }}
                      {{ end }}

                      **Liens utiles:**
                      • 📊 [Prometheus](http://151.80.152.63:9090)
                      • 📈 [Grafana](http://151.80.152.63:3001)
                      • 🚨 [Alertmanager](http://151.80.152.63:9093/#/alerts)
                      • 🔍 [API Health](http://151.80.152.63:3000/health)

                      ---
                      *Alertmanager - BenevoClic Monitoring*
                    send_resolved: true

            inhibit_rules:
              - source_match:
                  severity: 'critical'
                target_match:
                  severity: 'warning'
                equal: ['alertname']
              - source_match:
                  alert_type: 'server_down'
                target_match:
                  alert_type: 'server_inactive'
                equal: ['service']
            EOL
            

            
            # Monitoring docker-compose
            cat > ~/benevoclic/docker-compose.monitoring.yml << 'EOL'
            services:
              prometheus:
                image: prom/prometheus:latest
                container_name: prometheus
                restart: always
                ports: ["9090:9090"]
                volumes:
                  - ./prometheus.yml:/etc/prometheus/prometheus.yml
                  - ./alert_rules.yml:/etc/prometheus/alert_rules.yml
                  - prometheus_data:/prometheus
                command:
                  - '--config.file=/etc/prometheus/prometheus.yml'
                  - '--storage.tsdb.path=/prometheus'
                  - '--web.console.libraries=/etc/prometheus/console_libraries'
                  - '--web.console.templates=/etc/prometheus/consoles'
                  - '--storage.tsdb.retention.time=200h'
                  - '--web.enable-lifecycle'
                networks: [benevoclic-network]

              grafana:
                image: grafana/grafana:latest
                container_name: grafana
                restart: always
                ports: ["3001:3000"]
                environment:
                  - GF_SECURITY_ADMIN_USER=admin
                  - GF_SECURITY_ADMIN_PASSWORD=admin123
                  - GF_USERS_ALLOW_SIGN_UP=false
                volumes:
                  - grafana_data:/var/lib/grafana
                  - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
                  - ./grafana/datasources:/etc/grafana/provisioning/datasources
                networks: [benevoclic-network]

              node-exporter:
                image: prom/node-exporter:latest
                container_name: node-exporter
                restart: always
                ports: ["9100:9100"]
                volumes:
                  - /proc:/host/proc:ro
                  - /sys:/host/sys:ro
                  - /:/rootfs:ro
                command:
                  - '--path.procfs=/host/proc'
                  - '--path.rootfs=/rootfs'
                  - '--path.sysfs=/host/sys'
                  - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
                networks: [benevoclic-network]

              alertmanager:
                image: prom/alertmanager:latest
                container_name: alertmanager
                restart: always
                ports: ["9093:9093"]
                volumes:
                  - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
                  - alertmanager_data:/alertmanager
                command:
                  - '--config.file=/etc/alertmanager/alertmanager.yml'
                  - '--storage.path=/alertmanager'
                  - '--web.listen-address=:9093'
                networks: [benevoclic-network]

            volumes:
              prometheus_data:
              grafana_data:
              alertmanager_data:

            networks:
              benevoclic-network:
                external: true
            EOL
            
            # Grafana configs
            cat > ~/benevoclic/grafana/datasources/prometheus.yml << 'EOL'
            apiVersion: 1
            datasources:
              - name: Prometheus
                type: prometheus
                access: proxy
                url: http://prometheus:9090
                isDefault: true
                editable: true
            EOL
            
            cat > ~/benevoclic/grafana/dashboards/dashboards.yml << 'EOL'
            apiVersion: 1
            providers:
              - name: 'default'
                orgId: 1
                folder: ''
                type: file
                disableDeletion: false
                updateIntervalSeconds: 10
                allowUiUpdates: true
                options:
                  path: /etc/grafana/provisioning/dashboards
            EOL

            cd ~/benevoclic
            
            # Déployer
            echo "🛑 Arrêt des services..."
            docker-compose down || true
            docker-compose -f docker-compose.monitoring.yml down || true
            
            echo "🌐 Création du réseau..."
            docker network create benevoclic-network 2>/dev/null || true
            
            echo "📥 Téléchargement des images..."
            docker-compose pull
            
            echo "🚀 Démarrage de l'API..."
            docker-compose up -d
            
            echo "📊 Démarrage du monitoring..."
            docker-compose -f docker-compose.monitoring.yml up -d
            
            echo "⏳ Attente du démarrage..."
            sleep 20
            
            echo "✅ Déploiement terminé !"
            echo "📊 Prometheus: http://151.80.152.63:9090"
            echo "🚨 Alertmanager: http://151.80.152.63:9093"
            echo "📈 Grafana: http://151.80.152.63:3001"
            echo "🔍 API Health: http://151.80.152.63:3000/health"